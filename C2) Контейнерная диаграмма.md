# C2) Контейнерная диаграмма (Container Diagram)

## 1. Назначение диаграммы
Диаграмма контейнеров (Level 2 по модели C4) детализирует внутреннее устройство системы «Единая система аналитической отчетности». Она демонстрирует декомпозицию системы на отдельные развертываемые единицы (контейнеры), выбор технологий для каждого компонента и схему сетевого взаимодействия между ними.

Архитектура спроектирована по принципу **Микросервисной композиции** с четким разделением ответственности (Separation of Concerns).

---

## 2. Описание контейнеров

### 2.1. ETL Оркестратор
* **Технология:** `n8n` (Workflow Automation Tool).
* **Тип развертывания:** Docker Container (Self-hosted).
* **Функция:** Выступает в роли "интеграционной шины".
    * Инициирует подключения к API источников (1С, CRM).
    * Реализует логику **Data Quality Firewall**: проверяет входящие данные на соответствие типам и бизнес-правилам до их загрузки в БД.
    * Управляет расписанием инкрементальных загрузок.
    * Обрабатывает ошибки и отправляет алерты на почтовый сервер.

### 2.2. Аналитическое хранилище (DWH)
* **Технология:** `ClickHouse`.
* **Тип развертывания:** Docker Container.
* **Функция:** Центральный узел хранения и аналитической обработки.
    * Обеспечивает колоночное хранение данных, оптимизированное для OLAP-запросов (агрегации, фильтрации на лету).
    * Внутри контейнера реализована многослойная архитектура данных (Raw -> Core -> Marts).
    * Служит единственным источником правды для BI-системы.

### 2.3. BI Платформа
* **Технология:** `Yandex DataLens`.
* **Тип развертывания:** SaaS (Облачный сервис).
* **Функция:** Интерфейс конечного пользователя.
    * Визуализация данных (дашборды, чарты).
    * Реализация ролевой модели доступа (**RLS** — Row Level Security) на уровне датасетов.
    * Не хранит данные физически, а генерирует SQL-запросы к ClickHouse в режиме реального времени.

---

## 3. Сетевая топология и Безопасность

Архитектура разделена на две зоны безопасности, что соответствует требованиям к защите корпоративных данных:

### 3.1. Защищенный контур (Secure Zone)
* **Локация:** Внутренний сервер компании (Docker Host / Private VPS).
* **Компоненты:** `n8n`, `ClickHouse`.
* **Политика безопасности:**
    * Контейнеры не имеют прямого доступа из публичного интернета (изолированы Firewall).
    * Входящие соединения разрешены только с IP-адресов подсети Yandex Cloud (для работы DataLens) и офисной подсети администраторов.
    * Взаимодействие между n8n и ClickHouse происходит внутри виртуальной сети Docker Network, без выхода в общую сеть.

### 3.2. Облачный сегмент (Cloud SaaS)
* **Локация:** Инфраструктура Яндекс.
* **Компоненты:** `Yandex DataLens`.
* **Политика безопасности:**
    * Взаимодействие с пользователями осуществляется исключительно по защищенному протоколу **HTTPS (TLS 1.2+)**.
    * Аутентификация пользователей через Яндекс ID (или корпоративный SSO).

---

## 4. Потоки данных (Data Flows)

Процесс движения данных выстроен в конвейер (Pipeline):

1.  **Ingestion (Сбор):** `n8n` по расписанию (Cron) запрашивает пакеты данных из внешних систем (`HTTP GET` / `SMB Read`).
2.  **Validation (Проверка):** Внутри памяти `n8n` происходит валидация структуры. Если данные некорректны, поток прерывается, и `Mail Server` получает команду отправить алерт РОПу.
3.  **Loading (Загрузка):** Валидные данные пакетами (Batch) записываются в `ClickHouse` через HTTP-интерфейс (`Bulk Insert`).
4.  **Consumption (Потребление):**
    * Пользователь открывает дашборд.
    * `DataLens` отправляет SQL-запрос в `ClickHouse`.
    * `ClickHouse` вычисляет агрегат (например, "Сумма продаж за месяц") и возвращает результат.
    * `DataLens` отрисовывает график.

---

## 5. Обоснование выбора стека

| Контейнер | Выбор технологии | Обоснование |
| :--- | :--- | :--- |
| **ETL** | **n8n** | Позволяет сочетать скорость Low-code разработки с гибкостью JavaScript-кода для сложной валидации. Бесплатен при Self-hosted размещении. |
| **DWH** | **ClickHouse** | Лучшая производительность на рынке для аналитических запросов. Эффективное сжатие данных (экономия диска). Отечественное происхождение (импортозамещение). |
| **BI** | **DataLens** | Нативная интеграция с ClickHouse, отсутствие лицензионных платежей за пользователей, соответствие ФЗ-152 (сервера в РФ). |
