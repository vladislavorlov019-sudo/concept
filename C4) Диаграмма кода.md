# C4) Диаграмма кода (Code / Data Model)

## 1. Введение
На уровне C4 (Code Level) выполняется детализация физической реализации системы. В контексте аналитических систем (Data Engineering) под "кодом" понимаются:
1.  **Модель данных (Data Model):** Схемы таблиц, типы данных и связи в СУБД.
2.  **Алгоритмическая логика (Process Logic):** Сценарии обработки данных, правила валидации и трансформации.

Раздел содержит две проекции: статическую (структура БД ClickHouse) и динамическую (алгоритм ETL-процесса).

---

## 2. Модель данных ClickHouse (Static View)

Ядро системы построено на базе колоночной СУБД ClickHouse с использованием архитектурного паттерна **«Звезда» (Star Schema)**, оптимизированного для OLAP-нагрузок. Данные организованы в три логических слоя (Medallion Architecture).

### 2.1. Слой L1: Bronze (Staging)
* **Таблица:** `raw_logs_buffer`
* **Движок:** `MergeTree`
* **Назначение:** Технический буфер для входящих пакетов данных. Хранит историю загрузок в формате сырого JSON (`payload_json`).
* **Особенность:** Обеспечивает **идемпотентность** загрузки. При ошибке обработки можно воспроизвести транзакцию из сырого лога без повторного обращения к источнику.

### 2.2. Слой L2: Silver (Core / Star Schema)
Нормализованный слой, где данные разнесены по таблицам фактов и измерений.

**Таблица фактов (`fact_sales`):**
* **Движок:** `ReplicatedMergeTree` (для отказоустойчивости).
* **Ключ партиционирования:** `toYYYYMM(event_date)` — физическое разделение данных по месяцам ускоряет выборку за определенный период.
* **Метрики:** Хранит финансовые показатели (`revenue_rub` - Decimal18.2) и количественные (`quantity_kg` - Float64).

**Таблицы измерений (Dimensions):**
* **`dim_products` (Товары):** Использует тип `LowCardinality(String)` для строковых полей (Категория), что сокращает объем дискового пространства в разы.
* **`dim_clients` (Клиенты) и `dim_managers` (Персонал):** Используют движок `ReplacingMergeTree`.
    * *Механизм:* При вставке новой записи с тем же ID старая версия помечается как неактивная. Это автоматически решает проблему обновления справочников (SCD Type 1).

### 2.3. Слой L3: Gold (Data Marts)
* **Таблица:** `dm_sales_report`
* **Движок:** `AggregatingMergeTree`
* **Логика:** Хранит не строки транзакций, а промежуточные состояния агрегатных функций (`sumState`, `avgState`).
* **Преимущество:** Позволяет BI-системе получать отчеты любой глубины вложенности мгновенно, так как данные уже предрассчитаны на уровне вставки.

---

## 3. Алгоритм ETL-процесса (Dynamic View)

Диаграмма деятельности (Activity Diagram) описывает процедурную логику обработки неструктурированных файлов (планов продаж), реализованную в оркестраторе **n8n**. Алгоритм обеспечивает защиту хранилища от некорректных данных.

### 3.1. Инициализация и Парсинг
1.  **Event-Driven Trigger:** Процесс запускается событием файловой системы (`FileSystem Watcher`). Это исключает задержки (Latency), характерные для запуска по расписанию.
2.  **Chunking (Пагинация):** Для оптимизации потребления оперативной памяти (RAM) большие файлы разбиваются на пакеты (Chunks) по 1000 строк. Это предотвращает ошибки переполнения памяти (OOM) при обработке годовых бюджетов.

### 3.2. Трансформация (Function Node)
Внутри узла JS-функции выполняется нормализация:
* **Sanitization:** Удаление невидимых спецсимволов, trim пробелов, приведение дат к стандарту ISO-8601.
* **MDM Lookup:** Семантическое сопоставление. Система ищет `ID` товара по его текстовому названию через справочник синонимов. Если товар не найден, ему присваивается технический ID `UNKNOWN_PRODUCT`.

### 3.3. Валидация (Data Quality Firewall)
Реализован шлюз проверки бизнес-правил:
* *Правило 1:* Цена (`Price`) > 0.
* *Правило 2:* Количество (`Qty`) >= 0.
* *Правило 3:* Наличие обязательных полей (Клиент, Дата).

**Обработка исключений:**
Строки, не прошедшие валидацию, **не блокируют** весь файл. Они маршрутизируются в ветку **"Quarantine"** (Карантин), сохраняются в лог ошибок и отправляются администратору на Email. Валидные строки продолжают путь в базу данных.

### 3.4. Загрузка (Loading)
Используется стратегия **Batch Insert** (пакетная вставка) с механизмом **Retry Strategy**:
* В случае сетевого сбоя при записи в ClickHouse система предпринимает 3 попытки повторной отправки пакета с экспоненциальной задержкой.
* Только после исчерпания лимита попыток генерируется критический алерт.

---

## 4. Вывод
Представленная реализация уровня C4 демонстрирует зрелый подход к Data Engineering:
1.  Использование **типизированных схем** ClickHouse гарантирует эффективность хранения.
2.  Применение **Materialized Views** переносит нагрузку с BI-системы на базу данных.
3.  Алгоритм с **валидацией и карантином** обеспечивает высокую надежность данных, исключая "мусор" в аналитических отчетах.
