# C3) Диаграмма компонентов (Component Diagram)

## 1. Введение
На уровне C3 (Component Diagram) выполняется детализация ключевых контейнеров системы. Учитывая архитектурную сложность проекта, декомпозиция выполнена для двух критически важных узлов:
1.  **ETL-оркестратор (n8n):** Демонстрирует логику интеграции и конвейер контроля качества данных.
2.  **Аналитическое хранилище (ClickHouse):** Демонстрирует архитектуру данных и логику внутренних трансформаций (ELT).

---

## 2. Компонентная архитектура ETL (n8n)

Первая диаграмма иллюстрирует устройство интеграционного шлюза. Логика обработки выстроена по паттерну **Pipeline (Конвейер)**, где данные последовательно проходят через стадии очистки и валидации.

### 2.1. Слой Триггеров (Controllers)
Отвечает за инициализацию процессов обработки:
* **Schedule Trigger:** Реализует паттерн *Polling*. Инициирует запуск потоков синхронизации с API (1С, CRM) по расписанию (каждые 15 минут).
* **File Watcher:** Реализует событийно-ориентированный подход (*Event-Driven*). Мгновенно реагирует на появление новых файлов планов в сетевой папке, исключая задержки.

### 2.2. Слой Адаптеров (Connectors)
Изолирует бизнес-логику от технических особенностей источников:
* **Universal API Connector:** Унифицированный модуль для HTTP-запросов. Инкапсулирует логику авторизации (Bearer Token) и работу с пагинацией.
* **Excel Parser:** Преобразует бинарные `xlsx` файлы в стандартизированные JSON-массивы.

### 2.3. Слой Бизнес-логики (Processing Logic)
Ядро ETL-процесса:
* **Data Sanitizer:** Выполняет техническую очистку (удаление спецсимволов, форматирование дат в ISO-8601, унификация валют).
* **Model Mapper (MDM):** Отвечает за семантическую нормализацию. Сопоставляет входящие наименования товаров с эталонным справочником, устраняя разночтения в нейминге между системами.
* **Data Quality Firewall:** Логический шлюз безопасности. Проверяет данные на соответствие схеме (Schema Validation). Если запись не проходит валидацию (например, отрицательная цена или отсутствие ID), она блокируется.

### 2.4. Обработка ошибок
* **Error Handler:** Перехватывает сбойные транзакции и невалидные данные. Вместо остановки всей системы, компонент формирует лог инцидента и отправляет алерт администратору через SMTP-шлюз.

---

## 3. Компонентная архитектура Хранилища (ClickHouse)

Вторая диаграмма раскрывает внутреннее устройство базы данных. Используется подход **ELT (Extract-Load-Transform)**: "тяжелые" трансформации данных выполняются внутри СУБД средствами SQL, что обеспечивает высокую производительность.

Реализована многослойная архитектура **Medallion Architecture**:

### 3.1. Слой Bronze (Raw Layer)
* **Компонент:** `raw_import_log` (Engine: MergeTree).
* **Функция:** Буфер "грязных" данных. Сюда ETL-оркестратор пишет данные "как есть" (JSON). Это обеспечивает идемпотентность (возможность перезаливки) и полный аудиторский след.

### 3.2. Механизм Трансформации (Materialized Views)
* **Компонент:** `MV Triggers`.
* **Функция:** Активные триггеры, которые срабатывают в момент вставки данных. Они "на лету" парсят JSON, приводят типы данных и распределяют потоки по целевым таблицам. Это позволяет отказаться от внешних скриптов трансформации.

### 3.3. Слой Silver (Core Layer)
Нормализованное ядро хранилища (Схема «Звезда»):
* **Fact Tables:** Таблицы фактов (`fact_sales`) на движке `ReplicatedMergeTree`. Хранят очищенные транзакции.
* **Dimension Tables:** Справочники (`dim_products`) на движке `ReplacingMergeTree`. Хранят актуальные атрибуты объектов, автоматически устраняя дубликаты версий.

### 3.4. Слой Gold (Data Marts)
Витрины данных для BI-системы:
* **Компонент:** `dm_sales_report` (Engine: AggregatingMergeTree).
* **Функция:** Денормализованные "плоские" таблицы, где данные заранее соединены (JOIN) и агрегированы.
* **Результат:** При запросе дашборда база данных не выполняет вычисления с нуля, а отдает предрассчитанный результат, обеспечивая отклик интерфейса < 100 мс.

---

## 4. Вывод
Представленная компонентная архитектура обеспечивает:
1.  **Надежность:** За счет "пожарной перегородки" (Firewall) в n8n в базу не попадает мусор.
2.  **Производительность:** За счет переноса вычислений в ClickHouse (Materialized Views) отчеты строятся мгновенно.
3.  **Масштабируемость:** Разделение на слои позволяет легко добавлять новые источники данных, не ломая существующую логику витрин.
